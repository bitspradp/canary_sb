version: '1.0'

steps:

  build_image:
    title: Building Image
    type: build
    #Important: rename this image to to a valid repository in your registry. For example: myUserName/vote
    image_name: bitspradp/cd_demo_spin
    #Dockerfile location should be relative to the working directory
    dockerfile: Dockerfile

  push_to_registry:
    title: Pushing to Docker Registry
    type: push

    #A candidate is the image that we want to push to registry
    candidate: '${{build_image}}'

    # You can push the image with whatever tag you want. In our example we use CF_BRANCH, which is a variable in
    # the build process, accessible throughout the entire flow.
    tag: '${{CF_BRANCH}}'
  DeployToCluster:
    title: deploying to k8s cluster
    type: deploy
    stage: deploy
    kind: kubernetes
    cluster: pro-cluster
    namespace: default
    service: my-demo-servc
    candidate:
      image: index.docker.io/bitspradp/cd_demo_spin:master
      # The registry that the user's Kubernetes cluster can pull the image from
      # Codefresh will generate (if not found) secret and add it to the deployment so the Kubernetes master can pull it
      registry: dockerhub
    when:
      branch:
        only:
        - master

